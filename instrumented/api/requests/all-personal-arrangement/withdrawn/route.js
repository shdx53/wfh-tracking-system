function cov_8iaiukl0o() {
  var path = "/Users/ongsweelong/Library/CloudStorage/OneDrive-SingaporeManagementUniversity/Y3S1/SPM IS212/Project/wfh-tracking-system/app/api/requests/all-personal-arrangement/withdrawn/route.js";
  var hash = "579ef7eb8857ef7a226e538ff98252bd8890e22d";
  var global = new Function("return this")();
  var gcv = "__coverage__";
  var coverageData = {
    path: "/Users/ongsweelong/Library/CloudStorage/OneDrive-SingaporeManagementUniversity/Y3S1/SPM IS212/Project/wfh-tracking-system/app/api/requests/all-personal-arrangement/withdrawn/route.js",
    statementMap: {
      "0": {
        start: {
          line: 7,
          column: 2
        },
        end: {
          line: 120,
          column: 3
        }
      },
      "1": {
        start: {
          line: 9,
          column: 17
        },
        end: {
          line: 9,
          column: 35
        }
      },
      "2": {
        start: {
          line: 10,
          column: 17
        },
        end: {
          line: 10,
          column: 43
        }
      },
      "3": {
        start: {
          line: 13,
          column: 25
        },
        end: {
          line: 13,
          column: 53
        }
      },
      "4": {
        start: {
          line: 14,
          column: 20
        },
        end: {
          line: 14,
          column: 47
        }
      },
      "5": {
        start: {
          line: 15,
          column: 4
        },
        end: {
          line: 15,
          column: 38
        }
      },
      "6": {
        start: {
          line: 18,
          column: 62
        },
        end: {
          line: 18,
          column: 82
        }
      },
      "7": {
        start: {
          line: 21,
          column: 4
        },
        end: {
          line: 26,
          column: 5
        }
      },
      "8": {
        start: {
          line: 22,
          column: 6
        },
        end: {
          line: 25,
          column: 8
        }
      },
      "9": {
        start: {
          line: 29,
          column: 19
        },
        end: {
          line: 36,
          column: 5
        }
      },
      "10": {
        start: {
          line: 39,
          column: 4
        },
        end: {
          line: 45,
          column: 5
        }
      },
      "11": {
        start: {
          line: 40,
          column: 6
        },
        end: {
          line: 40,
          column: 21
        }
      },
      "12": {
        start: {
          line: 41,
          column: 6
        },
        end: {
          line: 44,
          column: 8
        }
      },
      "13": {
        start: {
          line: 49,
          column: 26
        },
        end: {
          line: 55,
          column: 5
        }
      },
      "14": {
        start: {
          line: 57,
          column: 4
        },
        end: {
          line: 64,
          column: 5
        }
      },
      "15": {
        start: {
          line: 58,
          column: 6
        },
        end: {
          line: 58,
          column: 74
        }
      },
      "16": {
        start: {
          line: 59,
          column: 6
        },
        end: {
          line: 59,
          column: 21
        }
      },
      "17": {
        start: {
          line: 60,
          column: 6
        },
        end: {
          line: 63,
          column: 8
        }
      },
      "18": {
        start: {
          line: 66,
          column: 22
        },
        end: {
          line: 66,
          column: 59
        }
      },
      "19": {
        start: {
          line: 69,
          column: 26
        },
        end: {
          line: 72,
          column: 5
        }
      },
      "20": {
        start: {
          line: 73,
          column: 24
        },
        end: {
          line: 73,
          column: 68
        }
      },
      "21": {
        start: {
          line: 75,
          column: 4
        },
        end: {
          line: 82,
          column: 5
        }
      },
      "22": {
        start: {
          line: 76,
          column: 6
        },
        end: {
          line: 76,
          column: 76
        }
      },
      "23": {
        start: {
          line: 77,
          column: 6
        },
        end: {
          line: 77,
          column: 21
        }
      },
      "24": {
        start: {
          line: 78,
          column: 6
        },
        end: {
          line: 81,
          column: 8
        }
      },
      "25": {
        start: {
          line: 84,
          column: 25
        },
        end: {
          line: 84,
          column: 48
        }
      },
      "26": {
        start: {
          line: 87,
          column: 20
        },
        end: {
          line: 87,
          column: 43
        }
      },
      "27": {
        start: {
          line: 88,
          column: 17
        },
        end: {
          line: 92,
          column: 46
        }
      },
      "28": {
        start: {
          line: 95,
          column: 4
        },
        end: {
          line: 105,
          column: 5
        }
      },
      "29": {
        start: {
          line: 96,
          column: 6
        },
        end: {
          line: 96,
          column: 53
        }
      },
      "30": {
        start: {
          line: 97,
          column: 6
        },
        end: {
          line: 97,
          column: 44
        }
      },
      "31": {
        start: {
          line: 99,
          column: 6
        },
        end: {
          line: 99,
          column: 69
        }
      },
      "32": {
        start: {
          line: 100,
          column: 6
        },
        end: {
          line: 100,
          column: 21
        }
      },
      "33": {
        start: {
          line: 101,
          column: 6
        },
        end: {
          line: 104,
          column: 8
        }
      },
      "34": {
        start: {
          line: 109,
          column: 4
        },
        end: {
          line: 109,
          column: 19
        }
      },
      "35": {
        start: {
          line: 112,
          column: 4
        },
        end: {
          line: 115,
          column: 6
        }
      },
      "36": {
        start: {
          line: 118,
          column: 4
        },
        end: {
          line: 118,
          column: 44
        }
      },
      "37": {
        start: {
          line: 119,
          column: 4
        },
        end: {
          line: 119,
          column: 108
        }
      }
    },
    fnMap: {
      "0": {
        name: "PUT",
        decl: {
          start: {
            line: 6,
            column: 22
          },
          end: {
            line: 6,
            column: 25
          }
        },
        loc: {
          start: {
            line: 6,
            column: 35
          },
          end: {
            line: 121,
            column: 1
          }
        },
        line: 6
      }
    },
    branchMap: {
      "0": {
        loc: {
          start: {
            line: 21,
            column: 4
          },
          end: {
            line: 26,
            column: 5
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 21,
            column: 4
          },
          end: {
            line: 26,
            column: 5
          }
        }, {
          start: {
            line: undefined,
            column: undefined
          },
          end: {
            line: undefined,
            column: undefined
          }
        }],
        line: 21
      },
      "1": {
        loc: {
          start: {
            line: 21,
            column: 8
          },
          end: {
            line: 21,
            column: 60
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 21,
            column: 8
          },
          end: {
            line: 21,
            column: 23
          }
        }, {
          start: {
            line: 21,
            column: 27
          },
          end: {
            line: 21,
            column: 42
          }
        }, {
          start: {
            line: 21,
            column: 46
          },
          end: {
            line: 21,
            column: 60
          }
        }],
        line: 21
      },
      "2": {
        loc: {
          start: {
            line: 39,
            column: 4
          },
          end: {
            line: 45,
            column: 5
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 39,
            column: 4
          },
          end: {
            line: 45,
            column: 5
          }
        }, {
          start: {
            line: undefined,
            column: undefined
          },
          end: {
            line: undefined,
            column: undefined
          }
        }],
        line: 39
      },
      "3": {
        loc: {
          start: {
            line: 57,
            column: 4
          },
          end: {
            line: 64,
            column: 5
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 57,
            column: 4
          },
          end: {
            line: 64,
            column: 5
          }
        }, {
          start: {
            line: undefined,
            column: undefined
          },
          end: {
            line: undefined,
            column: undefined
          }
        }],
        line: 57
      },
      "4": {
        loc: {
          start: {
            line: 57,
            column: 8
          },
          end: {
            line: 57,
            column: 52
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 57,
            column: 8
          },
          end: {
            line: 57,
            column: 22
          }
        }, {
          start: {
            line: 57,
            column: 26
          },
          end: {
            line: 57,
            column: 52
          }
        }],
        line: 57
      },
      "5": {
        loc: {
          start: {
            line: 75,
            column: 4
          },
          end: {
            line: 82,
            column: 5
          }
        },
        type: "if",
        locations: [{
          start: {
            line: 75,
            column: 4
          },
          end: {
            line: 82,
            column: 5
          }
        }, {
          start: {
            line: undefined,
            column: undefined
          },
          end: {
            line: undefined,
            column: undefined
          }
        }],
        line: 75
      },
      "6": {
        loc: {
          start: {
            line: 75,
            column: 8
          },
          end: {
            line: 75,
            column: 48
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 75,
            column: 8
          },
          end: {
            line: 75,
            column: 20
          }
        }, {
          start: {
            line: 75,
            column: 24
          },
          end: {
            line: 75,
            column: 48
          }
        }],
        line: 75
      },
      "7": {
        loc: {
          start: {
            line: 91,
            column: 23
          },
          end: {
            line: 91,
            column: 45
          }
        },
        type: "binary-expr",
        locations: [{
          start: {
            line: 91,
            column: 23
          },
          end: {
            line: 91,
            column: 36
          }
        }, {
          start: {
            line: 91,
            column: 40
          },
          end: {
            line: 91,
            column: 45
          }
        }],
        line: 91
      }
    },
    s: {
      "0": 0,
      "1": 0,
      "2": 0,
      "3": 0,
      "4": 0,
      "5": 0,
      "6": 0,
      "7": 0,
      "8": 0,
      "9": 0,
      "10": 0,
      "11": 0,
      "12": 0,
      "13": 0,
      "14": 0,
      "15": 0,
      "16": 0,
      "17": 0,
      "18": 0,
      "19": 0,
      "20": 0,
      "21": 0,
      "22": 0,
      "23": 0,
      "24": 0,
      "25": 0,
      "26": 0,
      "27": 0,
      "28": 0,
      "29": 0,
      "30": 0,
      "31": 0,
      "32": 0,
      "33": 0,
      "34": 0,
      "35": 0,
      "36": 0,
      "37": 0
    },
    f: {
      "0": 0
    },
    b: {
      "0": [0, 0],
      "1": [0, 0, 0],
      "2": [0, 0],
      "3": [0, 0],
      "4": [0, 0],
      "5": [0, 0],
      "6": [0, 0],
      "7": [0, 0]
    },
    _coverageSchema: "1a1c01bbd47fc00a2c39e90264f33305004495a9",
    hash: "579ef7eb8857ef7a226e538ff98252bd8890e22d"
  };
  var coverage = global[gcv] || (global[gcv] = {});
  if (!coverage[path] || coverage[path].hash !== hash) {
    coverage[path] = coverageData;
  }
  var actualCoverage = coverage[path];
  {
    // @ts-ignore
    cov_8iaiukl0o = function () {
      return actualCoverage;
    };
  }
  return actualCoverage;
}
cov_8iaiukl0o();
import connection from "@/app/lib/db";
import { NextResponse } from "next/server";
import { sendNotification } from "@/app/lib/notificationService.js";

// Example Endpoint: http://localhost:3000/api/requests/update-status
export async function PUT(request) {
  cov_8iaiukl0o().f[0]++;
  cov_8iaiukl0o().s[0]++;
  try {
    // Establish the connection using the pool
    const pool = (cov_8iaiukl0o().s[1]++, await connection());
    const conn = (cov_8iaiukl0o().s[2]++, await pool.getConnection());

    // Get Staff_ID input from the request
    const searchParams = (cov_8iaiukl0o().s[3]++, request.nextUrl.searchParams);
    const staffID = (cov_8iaiukl0o().s[4]++, searchParams.get("staffID"));
    cov_8iaiukl0o().s[5]++;
    console.log("Staff ID:", staffID);

    // Parse the request body to get Arrangement_ID, Request_Status, and Update_Reason
    const {
      Arrangement_ID,
      Request_Status,
      Update_Reason
    } = (cov_8iaiukl0o().s[6]++, await request.json());

    // Check that all parameters are provided
    cov_8iaiukl0o().s[7]++;
    if ((cov_8iaiukl0o().b[1][0]++, !Arrangement_ID) || (cov_8iaiukl0o().b[1][1]++, !Request_Status) || (cov_8iaiukl0o().b[1][2]++, !Update_Reason)) {
      cov_8iaiukl0o().b[0][0]++;
      cov_8iaiukl0o().s[8]++;
      return NextResponse.json({
        message: "Arrangement_ID, Request_Status, and Update_Reason are required."
      }, {
        status: 400
      } // Use 400 Bad Request for missing parameters
      );
    } else {
      cov_8iaiukl0o().b[0][1]++;
    }

    // Execute the query to update the Request_Status and Update_Reason
    const [data] = (cov_8iaiukl0o().s[9]++, await conn.query(`
      UPDATE Arrangement
      SET Request_Status = ?, Update_Reason = ?
      WHERE Arrangement_ID = ?;
      `, [Request_Status, Update_Reason, Arrangement_ID]));

    // Check if any rows were affected (i.e., whether the update was successful)
    cov_8iaiukl0o().s[10]++;
    if (data.affectedRows === 0) {
      cov_8iaiukl0o().b[2][0]++;
      cov_8iaiukl0o().s[11]++;
      conn.release();
      cov_8iaiukl0o().s[12]++;
      return NextResponse.json({
        message: "No arrangement found with the given Arrangement_ID."
      }, {
        status: 404
      } // Not Found status if no matching Arrangement_ID
      );
    } else {
      cov_8iaiukl0o().b[2][1]++;
    }

    // ----Preparation for Notification----
    // Get the reporting manager's ID for the current staff
    const managerResult = (cov_8iaiukl0o().s[13]++, await conn.query(`
      SELECT Reporting_Manager FROM Employee
      WHERE Staff_ID = ?
      `, [staffID]));
    cov_8iaiukl0o().s[14]++;
    if ((cov_8iaiukl0o().b[4][0]++, !managerResult) || (cov_8iaiukl0o().b[4][1]++, managerResult.length === 0)) {
      cov_8iaiukl0o().b[3][0]++;
      cov_8iaiukl0o().s[15]++;
      console.error(`No reporting manager found for staff ID ${staffID}`);
      cov_8iaiukl0o().s[16]++;
      conn.release();
      cov_8iaiukl0o().s[17]++;
      return NextResponse.json({
        message: `No reporting manager found for staff ID ${staffID}`
      }, {
        status: 404
      });
    } else {
      cov_8iaiukl0o().b[3][1]++;
    }
    const managerID = (cov_8iaiukl0o().s[18]++, managerResult[0][0].Reporting_Manager);

    // Get the email of the reporting manager
    const getEmailQuery = (cov_8iaiukl0o().s[19]++, `
      SELECT Email FROM Employee
      WHERE Staff_ID = ?
    `);
    const emailResult = (cov_8iaiukl0o().s[20]++, await conn.query(getEmailQuery, [managerID]));
    cov_8iaiukl0o().s[21]++;
    if ((cov_8iaiukl0o().b[6][0]++, !emailResult) || (cov_8iaiukl0o().b[6][1]++, emailResult.length === 0)) {
      cov_8iaiukl0o().b[5][0]++;
      cov_8iaiukl0o().s[22]++;
      console.error(`No email found for reporting manager ID ${managerID}`);
      cov_8iaiukl0o().s[23]++;
      conn.release();
      cov_8iaiukl0o().s[24]++;
      return NextResponse.json({
        message: `No email found for reporting manager ID ${managerID}`
      }, {
        status: 404
      });
    } else {
      cov_8iaiukl0o().b[5][1]++;
    }
    const managerEmail = (cov_8iaiukl0o().s[25]++, emailResult[0][0].Email);

    // Prepare email content
    const subject = (cov_8iaiukl0o().s[26]++, "WFH Request Withdrawn");
    const body = (cov_8iaiukl0o().s[27]++, `Dear Manager/Director ${managerID} (${managerEmail}),\n
    A work-from-home arrangement has been withdrawn:\n
    Staff ID: ${staffID}\n
    Withdraw Reason: ${(cov_8iaiukl0o().b[7][0]++, Update_Reason) || (cov_8iaiukl0o().b[7][1]++, "N/A")}\n\n
    Please review the request, thank you.\n\n`);

    // Send notification using Mailtrap (or any email service)
    cov_8iaiukl0o().s[28]++;
    try {
      cov_8iaiukl0o().s[29]++;
      console.log("Sending email to:", managerEmail);
      cov_8iaiukl0o().s[30]++;
      await sendNotification(subject, body);
    } catch (emailError) {
      cov_8iaiukl0o().s[31]++;
      console.error("Error sending email notification:", emailError);
      cov_8iaiukl0o().s[32]++;
      conn.release();
      cov_8iaiukl0o().s[33]++;
      return NextResponse.json({
        message: "Failed to send notification email.",
        details: emailError.message
      }, {
        status: 500
      });
    }
    // ----End of Notification----

    // Release the connection back to the pool
    cov_8iaiukl0o().s[34]++;
    conn.release();

    // Return success message if withdrawn was successful
    cov_8iaiukl0o().s[35]++;
    return NextResponse.json({
      message: "Arrangement is successfully withdrawn, and notification sent."
    }, {
      status: 200
    });
  } catch (error) {
    cov_8iaiukl0o().s[36]++;
    // Handle any errors and return an error response
    console.error("Error occurred:", error);
    cov_8iaiukl0o().s[37]++;
    return NextResponse.json({
      message: "Internal server error",
      details: error.message
    }, {
      status: 500
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb3ZfOGlhaXVrbDBvIiwiYWN0dWFsQ292ZXJhZ2UiLCJjb25uZWN0aW9uIiwiTmV4dFJlc3BvbnNlIiwic2VuZE5vdGlmaWNhdGlvbiIsIlBVVCIsInJlcXVlc3QiLCJmIiwicyIsInBvb2wiLCJjb25uIiwiZ2V0Q29ubmVjdGlvbiIsInNlYXJjaFBhcmFtcyIsIm5leHRVcmwiLCJzdGFmZklEIiwiZ2V0IiwiY29uc29sZSIsImxvZyIsIkFycmFuZ2VtZW50X0lEIiwiUmVxdWVzdF9TdGF0dXMiLCJVcGRhdGVfUmVhc29uIiwianNvbiIsImIiLCJtZXNzYWdlIiwic3RhdHVzIiwiZGF0YSIsInF1ZXJ5IiwiYWZmZWN0ZWRSb3dzIiwicmVsZWFzZSIsIm1hbmFnZXJSZXN1bHQiLCJsZW5ndGgiLCJlcnJvciIsIm1hbmFnZXJJRCIsIlJlcG9ydGluZ19NYW5hZ2VyIiwiZ2V0RW1haWxRdWVyeSIsImVtYWlsUmVzdWx0IiwibWFuYWdlckVtYWlsIiwiRW1haWwiLCJzdWJqZWN0IiwiYm9keSIsImVtYWlsRXJyb3IiLCJkZXRhaWxzIl0sInNvdXJjZXMiOlsicm91dGUuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNvbm5lY3Rpb24gZnJvbSBcIkAvYXBwL2xpYi9kYlwiO1xuaW1wb3J0IHsgTmV4dFJlc3BvbnNlIH0gZnJvbSBcIm5leHQvc2VydmVyXCI7XG5pbXBvcnQgeyBzZW5kTm90aWZpY2F0aW9uIH0gZnJvbSBcIkAvYXBwL2xpYi9ub3RpZmljYXRpb25TZXJ2aWNlLmpzXCI7XG5cbi8vIEV4YW1wbGUgRW5kcG9pbnQ6IGh0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvcmVxdWVzdHMvdXBkYXRlLXN0YXR1c1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIFBVVChyZXF1ZXN0KSB7XG4gIHRyeSB7XG4gICAgLy8gRXN0YWJsaXNoIHRoZSBjb25uZWN0aW9uIHVzaW5nIHRoZSBwb29sXG4gICAgY29uc3QgcG9vbCA9IGF3YWl0IGNvbm5lY3Rpb24oKTtcbiAgICBjb25zdCBjb25uID0gYXdhaXQgcG9vbC5nZXRDb25uZWN0aW9uKCk7XG5cbiAgICAvLyBHZXQgU3RhZmZfSUQgaW5wdXQgZnJvbSB0aGUgcmVxdWVzdFxuICAgIGNvbnN0IHNlYXJjaFBhcmFtcyA9IHJlcXVlc3QubmV4dFVybC5zZWFyY2hQYXJhbXM7XG4gICAgY29uc3Qgc3RhZmZJRCA9IHNlYXJjaFBhcmFtcy5nZXQoXCJzdGFmZklEXCIpO1xuICAgIGNvbnNvbGUubG9nKFwiU3RhZmYgSUQ6XCIsIHN0YWZmSUQpO1xuXG4gICAgLy8gUGFyc2UgdGhlIHJlcXVlc3QgYm9keSB0byBnZXQgQXJyYW5nZW1lbnRfSUQsIFJlcXVlc3RfU3RhdHVzLCBhbmQgVXBkYXRlX1JlYXNvblxuICAgIGNvbnN0IHsgQXJyYW5nZW1lbnRfSUQsIFJlcXVlc3RfU3RhdHVzLCBVcGRhdGVfUmVhc29uIH0gPSBhd2FpdCByZXF1ZXN0Lmpzb24oKTtcblxuICAgIC8vIENoZWNrIHRoYXQgYWxsIHBhcmFtZXRlcnMgYXJlIHByb3ZpZGVkXG4gICAgaWYgKCFBcnJhbmdlbWVudF9JRCB8fCAhUmVxdWVzdF9TdGF0dXMgfHwgIVVwZGF0ZV9SZWFzb24pIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBtZXNzYWdlOiBcIkFycmFuZ2VtZW50X0lELCBSZXF1ZXN0X1N0YXR1cywgYW5kIFVwZGF0ZV9SZWFzb24gYXJlIHJlcXVpcmVkLlwiIH0sXG4gICAgICAgIHsgc3RhdHVzOiA0MDAgfSAvLyBVc2UgNDAwIEJhZCBSZXF1ZXN0IGZvciBtaXNzaW5nIHBhcmFtZXRlcnNcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gRXhlY3V0ZSB0aGUgcXVlcnkgdG8gdXBkYXRlIHRoZSBSZXF1ZXN0X1N0YXR1cyBhbmQgVXBkYXRlX1JlYXNvblxuICAgIGNvbnN0IFtkYXRhXSA9IGF3YWl0IGNvbm4ucXVlcnkoXG4gICAgICBgXG4gICAgICBVUERBVEUgQXJyYW5nZW1lbnRcbiAgICAgIFNFVCBSZXF1ZXN0X1N0YXR1cyA9ID8sIFVwZGF0ZV9SZWFzb24gPSA/XG4gICAgICBXSEVSRSBBcnJhbmdlbWVudF9JRCA9ID87XG4gICAgICBgLFxuICAgICAgW1JlcXVlc3RfU3RhdHVzLCBVcGRhdGVfUmVhc29uLCBBcnJhbmdlbWVudF9JRF1cbiAgICApO1xuXG4gICAgLy8gQ2hlY2sgaWYgYW55IHJvd3Mgd2VyZSBhZmZlY3RlZCAoaS5lLiwgd2hldGhlciB0aGUgdXBkYXRlIHdhcyBzdWNjZXNzZnVsKVxuICAgIGlmIChkYXRhLmFmZmVjdGVkUm93cyA9PT0gMCkge1xuICAgICAgY29ubi5yZWxlYXNlKCk7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgbWVzc2FnZTogXCJObyBhcnJhbmdlbWVudCBmb3VuZCB3aXRoIHRoZSBnaXZlbiBBcnJhbmdlbWVudF9JRC5cIiB9LFxuICAgICAgICB7IHN0YXR1czogNDA0IH0gLy8gTm90IEZvdW5kIHN0YXR1cyBpZiBubyBtYXRjaGluZyBBcnJhbmdlbWVudF9JRFxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyAtLS0tUHJlcGFyYXRpb24gZm9yIE5vdGlmaWNhdGlvbi0tLS1cbiAgICAvLyBHZXQgdGhlIHJlcG9ydGluZyBtYW5hZ2VyJ3MgSUQgZm9yIHRoZSBjdXJyZW50IHN0YWZmXG4gICAgY29uc3QgbWFuYWdlclJlc3VsdCA9IGF3YWl0IGNvbm4ucXVlcnkoXG4gICAgICBgXG4gICAgICBTRUxFQ1QgUmVwb3J0aW5nX01hbmFnZXIgRlJPTSBFbXBsb3llZVxuICAgICAgV0hFUkUgU3RhZmZfSUQgPSA/XG4gICAgICBgLFxuICAgICAgW3N0YWZmSURdXG4gICAgKTtcblxuICAgIGlmICghbWFuYWdlclJlc3VsdCB8fCBtYW5hZ2VyUmVzdWx0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29uc29sZS5lcnJvcihgTm8gcmVwb3J0aW5nIG1hbmFnZXIgZm91bmQgZm9yIHN0YWZmIElEICR7c3RhZmZJRH1gKTtcbiAgICAgIGNvbm4ucmVsZWFzZSgpO1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IG1lc3NhZ2U6IGBObyByZXBvcnRpbmcgbWFuYWdlciBmb3VuZCBmb3Igc3RhZmYgSUQgJHtzdGFmZklEfWAgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwNCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IG1hbmFnZXJJRCA9IG1hbmFnZXJSZXN1bHRbMF1bMF0uUmVwb3J0aW5nX01hbmFnZXI7XG5cbiAgICAvLyBHZXQgdGhlIGVtYWlsIG9mIHRoZSByZXBvcnRpbmcgbWFuYWdlclxuICAgIGNvbnN0IGdldEVtYWlsUXVlcnkgPSBgXG4gICAgICBTRUxFQ1QgRW1haWwgRlJPTSBFbXBsb3llZVxuICAgICAgV0hFUkUgU3RhZmZfSUQgPSA/XG4gICAgYDtcbiAgICBjb25zdCBlbWFpbFJlc3VsdCA9IGF3YWl0IGNvbm4ucXVlcnkoZ2V0RW1haWxRdWVyeSwgW21hbmFnZXJJRF0pO1xuXG4gICAgaWYgKCFlbWFpbFJlc3VsdCB8fCBlbWFpbFJlc3VsdC5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYE5vIGVtYWlsIGZvdW5kIGZvciByZXBvcnRpbmcgbWFuYWdlciBJRCAke21hbmFnZXJJRH1gKTtcbiAgICAgIGNvbm4ucmVsZWFzZSgpO1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IG1lc3NhZ2U6IGBObyBlbWFpbCBmb3VuZCBmb3IgcmVwb3J0aW5nIG1hbmFnZXIgSUQgJHttYW5hZ2VySUR9YCB9LFxuICAgICAgICB7IHN0YXR1czogNDA0IH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgbWFuYWdlckVtYWlsID0gZW1haWxSZXN1bHRbMF1bMF0uRW1haWw7XG5cbiAgICAvLyBQcmVwYXJlIGVtYWlsIGNvbnRlbnRcbiAgICBjb25zdCBzdWJqZWN0ID0gXCJXRkggUmVxdWVzdCBXaXRoZHJhd25cIjtcbiAgICBjb25zdCBib2R5ID0gYERlYXIgTWFuYWdlci9EaXJlY3RvciAke21hbmFnZXJJRH0gKCR7bWFuYWdlckVtYWlsfSksXFxuXG4gICAgQSB3b3JrLWZyb20taG9tZSBhcnJhbmdlbWVudCBoYXMgYmVlbiB3aXRoZHJhd246XFxuXG4gICAgU3RhZmYgSUQ6ICR7c3RhZmZJRH1cXG5cbiAgICBXaXRoZHJhdyBSZWFzb246ICR7VXBkYXRlX1JlYXNvbiB8fCBcIk4vQVwifVxcblxcblxuICAgIFBsZWFzZSByZXZpZXcgdGhlIHJlcXVlc3QsIHRoYW5rIHlvdS5cXG5cXG5gO1xuXG4gICAgLy8gU2VuZCBub3RpZmljYXRpb24gdXNpbmcgTWFpbHRyYXAgKG9yIGFueSBlbWFpbCBzZXJ2aWNlKVxuICAgIHRyeSB7XG4gICAgICBjb25zb2xlLmxvZyhcIlNlbmRpbmcgZW1haWwgdG86XCIsIG1hbmFnZXJFbWFpbCk7XG4gICAgICBhd2FpdCBzZW5kTm90aWZpY2F0aW9uKHN1YmplY3QsIGJvZHkpO1xuICAgIH0gY2F0Y2ggKGVtYWlsRXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBzZW5kaW5nIGVtYWlsIG5vdGlmaWNhdGlvbjpcIiwgZW1haWxFcnJvcik7XG4gICAgICBjb25uLnJlbGVhc2UoKTtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBtZXNzYWdlOiBcIkZhaWxlZCB0byBzZW5kIG5vdGlmaWNhdGlvbiBlbWFpbC5cIiwgZGV0YWlsczogZW1haWxFcnJvci5tZXNzYWdlIH0sXG4gICAgICAgIHsgc3RhdHVzOiA1MDAgfVxuICAgICAgKTtcbiAgICB9XG4gICAgLy8gLS0tLUVuZCBvZiBOb3RpZmljYXRpb24tLS0tXG5cbiAgICAvLyBSZWxlYXNlIHRoZSBjb25uZWN0aW9uIGJhY2sgdG8gdGhlIHBvb2xcbiAgICBjb25uLnJlbGVhc2UoKTtcblxuICAgIC8vIFJldHVybiBzdWNjZXNzIG1lc3NhZ2UgaWYgd2l0aGRyYXduIHdhcyBzdWNjZXNzZnVsXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgeyBtZXNzYWdlOiBcIkFycmFuZ2VtZW50IGlzIHN1Y2Nlc3NmdWxseSB3aXRoZHJhd24sIGFuZCBub3RpZmljYXRpb24gc2VudC5cIiB9LFxuICAgICAgeyBzdGF0dXM6IDIwMCB9XG4gICAgKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAvLyBIYW5kbGUgYW55IGVycm9ycyBhbmQgcmV0dXJuIGFuIGVycm9yIHJlc3BvbnNlXG4gICAgY29uc29sZS5lcnJvcihcIkVycm9yIG9jY3VycmVkOlwiLCBlcnJvcik7XG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHsgbWVzc2FnZTogXCJJbnRlcm5hbCBzZXJ2ZXIgZXJyb3JcIiwgZGV0YWlsczogZXJyb3IubWVzc2FnZSB9LCB7IHN0YXR1czogNTAwIH0pO1xuICB9XG59Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7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